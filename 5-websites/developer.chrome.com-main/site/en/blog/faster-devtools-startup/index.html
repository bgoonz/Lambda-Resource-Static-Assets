<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2021-02-04" />
  <title>Improving DevTools startup time</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Improving DevTools startup time</h1>
<p class="date">2021-02-04</p>
</header>
<h2 id="devtools-startup-now-is-13-faster-from-11.2s-down-to-10s">DevTools startup now is ~13% faster ğŸ‰ (from 11.2s down to 10s)</h2>
<p>TL;DR; The result is achieved by removing a redundant serialization.</p>
<h2 id="overview">Overview</h2>
<p>While DevTools is starting up, it needs to make some calls to the <a href="https://v8.dev/">V8 JavaScript engine</a>.</p>
<p>{% Img src=â€œimage/dPDCek3EhZgLQPGtEG3y0fTn4v82/Cj4F4MSl0yvhWmELEHIQ.svgâ€, alt=â€œDevTools starting up processâ€, width=â€œ800â€, height=â€œ240â€ %}</p>
<p>The mechanism Chromium uses to send DevTools commands to V8 (and for IPC in general) is called <a href="https://chromium.googlesource.com/chromium/src/+/master/mojo/README.md"><code>mojo</code></a>. My teammates <a href="https://twitter.com/bmeurer">Benedikt Meurer</a> and <a href="https://twitter.com/sigurdschn">Sigurd Schneider</a> discovered an inefficiency while working on another task, and came up with an idea to improve the process by removing two redundant steps in how these messages are sent and received.</p>
<p>Let us dive into how the <code>mojo</code> mechanism works!</p>
<h2 id="the-mojo-mechanisms">The <code>mojo</code> mechanisms</h2>
<p>{% Img src=â€œimage/dPDCek3EhZgLQPGtEG3y0fTn4v82/zDmnw4p36OXC30YAwigz.svgâ€, alt=â€œThe mojo mechanismsâ€, width=â€œ800â€, height=â€œ600â€ %}</p>
<p>There is a mojo command <code>EvaluateScript</code> which runs the JS command. It serializes the whole JS command including the <code>arguments</code> into a string of JavaScript source code that can be <code>eval()</code>. As you might imagine, these strings can become quite long and expensive. After the command is received by V8, these strings of JavaScript code are deserialized before running. This process of serializing and deserializing for every single message creates significant overhead.</p>
<p>Benedikt Meurer realised that serialisation and deserialisation of the <code>arguments</code> is quite expensive, and that the whole <strong>â€œSerialize JS command to JS stringâ€</strong> and <strong>â€œDeserialize JS stringâ€</strong> steps are redundant and can be skipped.</p>
<p>Technical details: <a href="https://source.chromium.org/chromium/chromium/src/+/master:content/browser/renderer_host/render_frame_host_impl.cc;drc=df872ce8fcce25af51aa6b0f9fe8b1135b687524;l=1677"><code>RenderFrameHostImpl::ExecuteJavaScript</code></a></p>
<h2 id="how-we-improved">How we improved</h2>
<p>{% Img src=â€œimage/dPDCek3EhZgLQPGtEG3y0fTn4v82/PlyVRmhCEQ71hMCGqPqu.svgâ€, alt=â€œImproved mechanismsâ€, width=â€œ800â€, height=â€œ600â€ %}</p>
<p>We introduced another mojo API method which allows us to pass the object name, the method to be called, and the list of arguments directly, instead of having to create the string of JavaScript source code. This allows us to skip serialization &amp; deserialization, and removes the need to parse the JavaScript code.</p>
<p>For technical details on how we implemented this optimization, consult these two patches:</p>
<ol type="1">
<li><a href="https://chromium-review.googlesource.com/c/chromium/src/+/2431864">CL 2431864: [devtools] Reduce performance overhead of message dispatch in the front-end</a></li>
<li><a href="https://chromium-review.googlesource.com/c/chromium/src/+/2442012">CL 2442012: [devtools] Use <code>ExecuteJavaScriptMethod</code> in DevTools</a></li>
</ol>
<h2 id="impact">Impact</h2>
<p>To measure the effectiveness of the change, we ran some measurements comparing Chromium revisions <a href="https://chromium.googlesource.com/chromium/src/+/cb971089a058160601940d2b2a12d360115f66e5">cb971089a058</a> and <a href="https://chromium.googlesource.com/chromium/src/+/4f213b39d581eaa69a6d70378c91de2768e0004a">4f213b39d581</a> (before and after the change).</p>
<p>For both revisions, we ran the following scenario 5 times:</p>
<ol type="1">
<li>Record trace using <code>chrome://tracing</code></li>
<li>Open DevTools-on-DevTools</li>
<li>Get the recorded <code>CrRendererMain</code> trace and compare the V8-specific metrics.</li>
</ol>
<p>Based on these experiments, DevTools opens <strong>~13% faster (from 11.2s down to 10s)</strong> with the optimization.</p>
<h3 id="hightlights-cpu-durations">Hightlights, CPU durations</h3>
<table class="responsive" markdown="1">
<thead>
<tr>
<td>
<strong>Method name</strong>
</td>
<td>
<strong>Not optimized (ms)</strong>
</td>
<td>
<strong>Optimized (ms)</strong>
</td>
<td>
<strong>Differences (ms)</strong>
</td>
<td>
<strong>Speed improvement (%)</strong>
</td>
</tr>
</thead>
<tbody>
<tr>
<td>
<strong>Total</strong>
</td>
<td style="text-align: right;">
<strong>11,213.19</strong>
</td>
<td style="text-align: right;">
<strong>9,953.99</strong>
</td>
<td style="text-align: right;">
<strong>-1,259.20</strong>
</td>
<td style="text-align: right;">
<strong>12.65%</strong>
</td>
</tr>
<tr>
<td>
v8.run
</td>
<td style="text-align: right;">
499.67
</td>
<td style="text-align: right;">
3.61
</td>
<td style="text-align: right;">
-496.06
</td>
<td style="text-align: right;">
12.65%
</td>
</tr>
<tr>
<td>
V8.Execute
</td>
<td style="text-align: right;">
1,654.87
</td>
<td style="text-align: right;">
1,349.61
</td>
<td style="text-align: right;">
-305.25
</td>
<td style="text-align: right;">
3.07%
</td>
</tr>
<tr>
<td>
v8.callFunction
</td>
<td style="text-align: right;">
1,171.84
</td>
<td style="text-align: right;">
1,339.77
</td>
<td style="text-align: right;">
167.94
</td>
<td style="text-align: right;">
-1.69%
</td>
</tr>
<tr>
<td>
v8.compile
</td>
<td style="text-align: right;">
133.93
</td>
<td style="text-align: right;">
3.56
</td>
<td style="text-align: right;">
-130.37
</td>
<td style="text-align: right;">
1.31%
</td>
</tr>
</tbody>
</table>
<p>{% Img src=â€œimage/dPDCek3EhZgLQPGtEG3y0fTn4v82/WFqwQ1dMTdEh3v5oH1pP.svgâ€, alt=â€œDevTools load CPU time (ms)â€, width=â€œ800â€, height=â€œ448â€ %}</p>
<p><a href="https://docs.google.com/spreadsheets/d/1WuWWORPwMre3m4N_MmJvtJ0xTfq-oBnz87cGtB532Ms/edit?resourcekey=0-Xxv_HIGfVaIZvbmDrmZ2GA">Full tracing metrics comparison table</a></p>
<p>As a result, DevTools opens and <strong>works faster with less CPU usage</strong>. ğŸ‰</p>
</body>
</html>
